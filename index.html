<html>
<style>
html, body {
	height:98%;
	border:0px;
	margin: 0 0 0 0;
	margin-bottom:-200px
}
body {
	position: relative;
}
.overlay {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 104%;
	z-index: 10;
	margin:0 0 0 0;
	background-color: rgba(255,0,0,0.1); /*dim the background*/
}
.player {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	z-index: 5;
	margin:0 0 0 0;
}
</style>
<body style="background-color:black">

	<div class="overlay" style="text-align:center">
		<div style="color:white;margin-top:30%">
			<strong> aucun flux en cour de lecture </strong>
		</div>
	</div>
	<div class="player">
		<canvas id="canvas" style="width:100%;height:100%"/>
	</div>
<script src="./public/js/plugins/socket.io/socket.io.min.js"></script>
<script>
var path = require('path');
window.$ = window.jQuery = require(path.join(__dirname, './public/js/plugins/jquery/jquery.min.js'));
var canvas = document.getElementById("canvas");
var renderContext = require("webgl-video-renderer").setupCanvas(canvas);
var player = require("webchimera.js").VlcPlayer();
var socket = io.connect('http://localhost:1337');
var volume = 0;

player.onFrameReady = function(frame) {
	renderContext.render(frame, frame.width, frame.height, frame.uOffset, frame.vOffset);
}

socket.on('connect', function(){
	console.log('im connected to socket system');
	socket.emit('authentification', 'player');
});

socket.on('state', function(b) {
	socket.emit('state', {
		state: player.state,
		playing: player.playing,
		position: player.position,
		time:player.time,
		volume:player.volume,
		mute:player.mute
	});
});

player.onPlaying = function() {
	$(".overlay").hide();
	player.volume = volume;
	console.log(player.playlist.items[player.playlist.currentItem]);
	socket.emit('player-start', player.length, {
			title: player.playlist.items[player.playlist.currentItem].title,
			img:player.playlist.items[player.playlist.currentItem].artworkURL
		}, volume);
}

player.onTimeChanged = function(time) {
	socket.emit('player-time-changed', {current: time, total: player.length});
}

player.onStopped = function() {
	$(".overlay").show();
	socket.emit('player-stopped', true);
}

socket.on('on-item', function(b) {
	// ask the current item playing when a controller reconnect //
	var title = player.playlist.items[player.playlist.currentItem].title;
	var img = player.playlist.items[player.playlist.currentItem].artworkURL;
	socket.emit('refresh-player-playing', {title:title, img:img});
	socket.emit('player-time-changed', {current: player.time, total: player.length});
	socket.emit('player-volume', volume);
});

socket.on('playlist-next', function(b) {
	player.playlist.next();
});

socket.on('playlist-back', function(b) {
	player.playlist.prev();
});

socket.on('playlist-pause', function(b) {
	player.playlist.togglePause();
});

socket.on('playlist-play', function(b) {
	player.playlist.play();
});

socket.on('playlist-stop', function(b) {
	player.playlist.stop();
});

socket.on('volume-up', function(b) {
	volume += 10;
	if (volume > 100)
		volume -= 10;
	player.volume = volume;
	socket.emit('player-volume', volume);
});

socket.on('volume-down', function(b) {
	volume -= 10;
	if (volume < 0)
		volume += 10;
	player.volume = volume;
	socket.emit('player-volume', volume);
});

socket.on('play-item', function(item, index) {
	var id = player.playlist.add(item.url);
	player.playlist.playItem(id);
});

socket.on('add-item', function(item, index) {
	var id = player.playlist.add(item.url);
	player.playlist.items[id].title = index;
});

</script>

</body>

</html>
